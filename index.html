<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>LoanNex Automation Portal</title>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
      <script src="https://cdn.tailwindcss.com"></script>
      <!-- Validation scripts commented out temporarily while we fix the integration -->
      <!-- <script src="loan-validator.js"></script>
      <script src="validation-ui.js"></script> -->
      <style>
         body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
         .hidden { display: none !important; }
         .progress-bar { transition: width 0.3s ease; }
         .pulse { animation: pulse 2s infinite; }
         @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
         .fade-in { animation: fadeIn 0.5s ease-in; }
         @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
         /* News ticker animation */
         .animate-scroll {
         animation: scroll 60s linear infinite;
         }
         @keyframes scroll {
         0% { transform: translateX(100%); }
         100% { transform: translateX(-100%); }
         }
         /* Floating particles background */
         .particles-container {
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         pointer-events: none;
         z-index: 1;
         overflow: hidden;
         }
         .particle {
         position: absolute;
         width: 3px;
         height: 3px;
         background: rgba(59, 130, 246, 0.4);
         border-radius: 50%;
         animation: float 20s infinite linear;
         }
         .particle:nth-child(odd) {
         background: rgba(139, 92, 246, 0.3);
         animation-duration: 25s;
         }
         .particle:nth-child(3n) {
         background: rgba(16, 185, 129, 0.3);
         animation-duration: 30s;
         width: 2px;
         height: 2px;
         }
         @keyframes float {
         0% {
         transform: translateY(100vh) translateX(0px) rotate(0deg);
         opacity: 0;
         }
         10% {
         opacity: 1;
         }
         90% {
         opacity: 1;
         }
         100% {
         transform: translateY(-10vh) translateX(100px) rotate(360deg);
         opacity: 0;
         }
         }
         /* Gradient border animations */
         .gradient-border {
         position: relative;
         background: white;
         }
         .gradient-border::before {
         content: '';
         position: absolute;
         inset: 0;
         padding: 2px;
         background: linear-gradient(45deg, #3b82f6, #8b5cf6, #10b981, #f59e0b, #ef4444, #3b82f6);
         background-size: 300% 300%;
         border-radius: inherit;
         animation: gradientShift 3s ease infinite;
         mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
         -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
         mask-composite: xor;
         -webkit-mask-composite: xor;
         }
         .gradient-border-subtle {
         position: relative;
         background: white;
         }
         .gradient-border-subtle::before {
         content: '';
         position: absolute;
         inset: 0;
         padding: 1px;
         background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
         background-size: 200% 200%;
         border-radius: inherit;
         animation: gradientShift 4s ease-in-out infinite;
         mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
         -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
         mask-composite: xor;
         -webkit-mask-composite: xor;
         }
         @keyframes gradientShift {
         0%, 100% {
         background-position: 0% 50%;
         }
         50% {
         background-position: 100% 50%;
         }
         }
         /* Enhanced content positioning */
         .content-layer {
         position: relative;
         z-index: 10;
         }
         /* Fix for form inputs inside gradient borders */
         .gradient-border input,
         .gradient-border button,
         .gradient-border select,
         .gradient-border textarea,
         .gradient-border label,
         .gradient-border .cursor-pointer {
         position: relative;
         z-index: 20;
         }
         .gradient-border-subtle input,
         .gradient-border-subtle button,
         .gradient-border-subtle select,
         .gradient-border-subtle textarea,
         .gradient-border-subtle label,
         .gradient-border-subtle .cursor-pointer {
         position: relative;
         z-index: 20;
         }
         /* Ensure all content inside gradient borders is clickable */
         .gradient-border > *,
         .gradient-border-subtle > * {
         position: relative;
         z-index: 15;
         }
         /* Custom styles for pricing table */
         .pricing-table {
           max-height: 150vh; /* Fixed height for up to ~20-25 loans */
           overflow-y: auto; /* Add scrollbar when needed */
           overflow-x: auto; /* Handle wide tables */
           border: 1px solid #e5e7eb; /* Add border to define container */
          }
         .rate-highlight {
         background: linear-gradient(135deg, #10b981, #059669);
         color: white;
         font-weight: bold;
         padding: 2px 6px;
         border-radius: 4px;
         }
         .loan-row:hover {
         background-color: #f3f4f6;
         }
         .loan-row.selected {
         background-color: #dbeafe;
         border-left: 4px solid #3b82f6;
         }
         /* Enhanced validation styles */
         .validation-row-error { 
             background-color: #fef2f2; 
             border-left: 4px solid #ef4444; 
             transition: all 0.3s ease;
         }
         .validation-row-warning { 
             background-color: #fffbeb; 
             border-left: 4px solid #f59e0b; 
             transition: all 0.3s ease;
         }
         .validation-row-valid { 
             background-color: #f0fdf4; 
             border-left: 4px solid #10b981; 
             transition: all 0.3s ease;
         }

         /* Enhanced animations */
         .validation-slide-in { 
             animation: slideInFromTop 0.5s ease-out; 
         }
         @keyframes slideInFromTop { 
             from { opacity: 0; transform: translateY(-20px); } 
             to { opacity: 1; transform: translateY(0); } 
         }

         /* Data preview table styles */
         .data-preview-table {
             max-height: 400px;
             overflow-y: auto;
             border: 1px solid #e5e7eb;
         }

         .expandable-row {
             cursor: pointer;
             transition: all 0.2s ease;
             border-radius: 4px;
         }
         
         .expandable-row:hover {
             background-color: #f9fafb !important;
             transform: translateY(-1px);
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }

         /* Field validation status colors */
         .field-valid { 
             background-color: #f0fdf4; 
             color: #166534; 
             padding: 2px 6px;
             border-radius: 4px;
         }
         .field-warning { 
             background-color: #fffbeb; 
             color: #a16207; 
             padding: 2px 6px;
             border-radius: 4px;
         }
         .field-error { 
             background-color: #fef2f2; 
             color: #dc2626; 
             padding: 2px 6px;
             border-radius: 4px;
         }

         /* Enhanced summary cards */
         .validation-summary-card {
             transition: all 0.3s ease;
         }
         
         .validation-summary-card:hover {
             transform: translateY(-2px);
             box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
         }
         
         /* Success message animation */
         .success-message {
             animation: successPulse 0.6s ease-out;
         }
         
         @keyframes successPulse {
             0% {
                 opacity: 0;
                 transform: scale(0.8);
             }
             50% {
                 transform: scale(1.05);
             }
             100% {
                 opacity: 1;
                 transform: scale(1);
             }
         }

         /* Fix button styles */
         .fix-field-btn, .fix-loan-btn {
             transition: all 0.2s ease;
         }
         
         .fix-field-btn:hover, .fix-loan-btn:hover {
             transform: scale(1.05);
             box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
         }
         
         /* Responsive grid for loan details */
         @media (max-width: 768px) {
             .data-preview-table .grid-cols-7 {
                 grid-template-columns: repeat(3, 1fr);
                 gap: 2px;
             }
             
             .data-preview-table .grid-cols-7 > div:nth-child(n+4) {
                 display: none;
             }
         }
      </style>
   </head>
   <body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Add this audio element -->
    <audio id="pricing-complete-audio" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYeBC2Bzfzdn0UNF2y48+OGSA0PVqzn77BdGAg7k9n1unYiBC6Aufzdi0wOGWO28+KNSA0PVKzp8LRgHAU9k9j4w3QiBC7Aufzcik0OF2C1+OWTPAkUY6/q8MV4IBkZgtG8RoaFaDZeqD2/Cm5Y2r7E8PJhAEgpnfXBpjVfOzd5NmlNfnLQcYIVRjLb23/UR13XU+DKjmE/TcNiCCNiRqO1L8jzCe5yLmVk2nKDQiMpOJwm1Xg/FUcQmN0Mnt/7K2xJKhQOGOsNBQdMLtYMdNADQzxD8Lc8Kgc/bgHMK+fKSk9k8r6R3VnG6nnLk+a4vlBELIAVOT3P3VKgvN1Tm7k8YlVHKJ/1Eh5Q" type="audio/wav">
    </audio>
      <!-- Floating Particles Background -->
      <div class="particles-container" id="particles-container"></div>
      <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 content-layer">
      <!-- Non-QM News Ticker -->
      <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-3 overflow-hidden">
         <div class="max-w-7xl mx-auto flex items-center">
            <div class="bg-white text-blue-700 px-3 py-1 rounded-full text-sm font-bold mr-4 flex-shrink-0">
               📈 NON-QM NEWS
            </div>
            <div class="overflow-hidden flex-1">
               <div id="news-ticker" class="whitespace-nowrap animate-scroll text-sm">
                  <span class="inline-block mr-12">🚀 2025 predicted to be strongest year for Non-QM market</span>
                  <span class="inline-block mr-12">💰 A&D Mortgage closes $427M securitization</span>
                  <span class="inline-block mr-12">📊 Non-QM market now 5% of total mortgage market</span>
                  <span class="inline-block mr-12">⭐ Average Non-QM credit score: 776</span>
               </div>
            </div>
         </div>
      </div>
      <div class="max-w-7xl mx-auto p-6">
         <!-- Collapsible Data Flow Architecture -->
         <div class="mb-6">
            <div class="gradient-border-subtle rounded-xl shadow-lg overflow-hidden">
               <button 
                  id="architecture-toggle" 
                  class="w-full p-4 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300 flex items-center justify-between group"
                  >
                  <div class="flex items-center space-x-3">
                     <div class="bg-blue-600 text-white p-2 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                     </div>
                     <div class="text-left">
                        <h3 class="font-bold text-gray-900 text-lg">LoanNex Data Processing Pipeline</h3>
                        <p class="text-sm text-gray-600">View the complete automation workflow architecture</p>
                     </div>
                  </div>
                  <div class="flex items-center space-x-2">
                     <span class="text-xs text-blue-600 font-medium group-hover:text-blue-700">Click to expand</span>
                     <svg id="expand-icon" class="w-6 h-6 text-blue-600 transition-transform duration-300 group-hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                     </svg>
                  </div>
               </button>
               <div id="architecture-content" class="hidden border-t border-gray-200">
                  <div class="p-6 bg-white">
                     <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                        <!-- INPUT PHASE -->
                        <div class="space-y-3">
                           <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-3 rounded-lg">
                              <h4 class="font-bold text-blue-900 text-sm mb-2">INPUT PHASE</h4>
                              <div class="text-xs text-blue-800 leading-relaxed">
                                 📊 EXCEL UPLOAD<br>
                                 ↓<br>
                                 🔍 VALIDATION<br>
                                 ↓<br>
                                 ✅ AUTHENTICATION<br>
                                 ↓<br>
                                 📋 PREVIEW
                              </div>
                           </div>
                           <div class="text-xs text-gray-700 space-y-1">
                              <div>• Upload loan spreadsheet</div>
                              <div>• Validate file format</div>
                              <div>• Verify LoanNex credentials</div>
                              <div>• Display data preview</div>
                           </div>
                        </div>
                        <!-- PROCESSING PHASE -->
                        <div class="space-y-3">
                           <div class="bg-gradient-to-r from-green-100 to-green-200 p-3 rounded-lg">
                              <h4 class="font-bold text-green-900 text-sm mb-2">PROCESSING PHASE</h4>
                              <div class="text-xs text-green-800 leading-relaxed">
                                 ⚡ API ORCHESTRATION<br>
                                 ↓<br>
                                 🚀 WORKFLOW LAUNCH<br>
                                 ↓<br>
                                 🖥️ BROWSER AUTOMATION
                              </div>
                           </div>
                           <div class="text-xs text-gray-700 space-y-1">
                              <div>• Trigger GitHub workflows</div>
                              <div>• Provision Ubuntu VMs</div>
                              <div>• Navigate with Selenium</div>
                              <div>• Chrome browser setup</div>
                           </div>
                        </div>
                        <!-- AUTOMATION PHASE -->
                        <div class="space-y-3">
                           <div class="bg-gradient-to-r from-purple-100 to-purple-200 p-3 rounded-lg">
                              <h4 class="font-bold text-purple-900 text-sm mb-2">AUTOMATION PHASE</h4>
                              <div class="text-xs text-purple-800 leading-relaxed">
                                 🏦 LOANNEX LOGIN<br>
                                 ↓<br>
                                 📝 FIELD POPULATION<br>
                                 ↓<br>
                                 💰 PRICE GENERATION<br>
                                 ↓<br>
                                 🎯 SMART FILTERING
                              </div>
                           </div>
                           <div class="text-xs text-gray-700 space-y-1">
                              <div>• Secure authentication</div>
                              <div>• Populate 23+ fields</div>
                              <div>• Generate pricing data</div>
                              <div>• Apply loan filters</div>
                           </div>
                        </div>
                        <!-- EXECUTION PHASE -->
                        <div class="space-y-3">
                           <div class="bg-gradient-to-r from-orange-100 to-orange-200 p-3 rounded-lg">
                              <h4 class="font-bold text-orange-900 text-sm mb-2">EXECUTION PHASE</h4>
                              <div class="text-xs text-orange-800 leading-relaxed">
                                 🔒 LOCK ATTEMPT<br>
                                 ↓<br>
                                 📊 LOG ANALYSIS<br>
                                 ↓<br>
                                 📈 REAL-TIME MONITORING<br>
                                 ↓<br>
                                 ✅ RESULT CAPTURE
                              </div>
                           </div>
                           <div class="text-xs text-gray-700 space-y-1">
                              <div>• Execute loan lock</div>
                              <div>• Parse automation logs</div>
                              <div>• Auto-poll every 30s</div>
                              <div>• Correlate results</div>
                           </div>
                        </div>
                        <!-- OUTPUT PHASE -->
                        <div class="space-y-3">
                           <div class="bg-gradient-to-r from-red-100 to-red-200 p-3 rounded-lg">
                              <h4 class="font-bold text-red-900 text-sm mb-2">OUTPUT PHASE</h4>
                              <div class="text-xs text-red-800 leading-relaxed">
                                 📋 DATA COMPILATION<br>
                                 ↓<br>
                                 📊 EXCEL GENERATION<br>
                                 ↓<br>
                                 📥 PROFESSIONAL DOWNLOAD
                              </div>
                           </div>
                           <div class="text-xs text-gray-700 space-y-1">
                              <div>• Match loan data</div>
                              <div>• Generate Excel report</div>
                              <div>• Timestamped results</div>
                              <div>• Actionable insights</div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
         <div class="grid grid-cols-1 gap-6">
            <!-- Main Content Area (Full Width) -->
            <div>
               <div id="app">
                  <!-- Header -->
                  <div class="text-center mb-8">
                     <h1 class="text-4xl font-bold text-gray-900 mb-2">🏦 LoanNex Automation Portal</h1>
                     <p class="text-lg text-gray-600">Simple, reliable loan processing and lock automation</p>
                  </div>
                  <!-- Upload Section -->
                  <div id="upload-section" class="gradient-border rounded-xl shadow-lg p-8 mb-6">
                     <h2 class="text-2xl font-semibold mb-3 text-center">Process Your Loans</h2>
                     
                     <!-- Credentials -->
                     <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                           <label for="username" class="block text-sm font-medium text-gray-700 mb-2">LoanNex Username</label>
                           <input 
                              type="text" 
                              id="username" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              placeholder="Enter username"
                              required
                              >
                        </div>
                        <div>
                           <label for="password" class="block text-sm font-medium text-gray-700 mb-2">LoanNex Password</label>
                           <input 
                              type="password" 
                              id="password" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                              placeholder="Enter password"
                              required
                              >
                        </div>
                     </div>
                     
                     <!-- File Upload -->
                     <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="mb-4">
                           <label for="file-upload" class="cursor-pointer">
                           <span class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-block font-medium">
                           Upload Excel File
                           </span>
                           <input id="file-upload" type="file" class="hidden" accept=".xlsx,.xls">
                           </label>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">Upload your loan data in Excel format</p>
                        <!-- Template Download Button -->
                        <div class="pt-3 border-t border-gray-200">
                           <button id="download-template" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium">
                           📥 Download Excel Template
                           </button>
                           <p class="text-xs text-gray-500 mt-2">Get the required format with allowable values</p>
                        </div>
                     </div>

                     <!-- VALIDATION SECTION (NEW POSITION - AFTER FILE UPLOAD) -->
                     <div id="validation-section" class="hidden gradient-border-subtle rounded-xl shadow-lg p-6 mb-6 validation-slide-in">
                        <!-- This content will be populated by JavaScript -->
                     </div>

                     <!-- WORKFLOW BUTTONS SECTION (MOVED UP - AFTER VALIDATION) -->
                     <div id="workflow-buttons-section" class="hidden">
                        <!-- Save checkbox -->
                        <div class="mb-6 text-center">
                           <label class="flex items-center justify-center space-x-2 text-sm text-gray-700">
                              <input type="checkbox" id="save-after-pricing" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                              <span>💾 Auto-save loans in LoanNex after pricing</span>
                           </label>
                           <p class="text-xs text-gray-500 mt-1">Saves each loan and captures NexID for tracking</p>
                        </div>

                        <!-- Simple 4 Steps -->
                        <div class="text-center mb-6">
                           <p class="text-lg text-gray-600">
                              <span class="font-medium">1. Enter credentials</span> → 
                              <span class="font-medium">2. Upload Excel</span> → 
                              <span class="font-medium">3. Choose workflow</span> → 
                              <span class="font-medium">4. Download results</span>
                           </p>
                        </div>

                        <!-- TWO PROCESS BUTTONS -->
                        <div class="text-center">
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-5xl mx-auto">
                              <!-- Price Review Button with Description -->
                              <div class="flex flex-col items-center space-y-3">
                                 <button id="price-review-btn" class="bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg w-full">
                                 💰 Price & Review Loans
                                 </button>
                                 <p class="text-lg text-gray-700 font-semibold whitespace-nowrap">
                                    Get pricing, then select loans to lock
                                 </p>
                              </div>
                              
                              <!-- Process & Lock Button with Description -->
                              <div class="flex flex-col items-center space-y-3">
                                 <button id="process-btn" class="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg w-full">
                                 🔒 Process & Lock Loans
                                 </button>
                                 <p class="text-lg text-gray-700 font-semibold whitespace-nowrap">
                                    Automatically process and lock all loans
                                 </p>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>

                  <!-- Processing Section -->
                  <div id="processing-section" class="hidden gradient-border-subtle rounded-xl shadow-lg p-8 mb-6">
                     <div class="text-center">
                        <div class="mb-6">
                           <div class="inline-flex items-center text-blue-600 text-xl font-medium mb-4">
                              <div class="pulse mr-3">⚡</div>
                              <span id="processing-title">Processing <span id="total-loans">0</span> loans...</span>
                           </div>
                        </div>
                        <!-- Progress Bar -->
                        <div class="mb-6">
                           <div class="w-full bg-gray-200 rounded-full h-4">
                              <div id="progress-bar" class="bg-blue-600 h-4 rounded-full progress-bar" style="width: 0%"></div>
                           </div>
                           <p class="text-sm text-gray-500 mt-2" id="progress-detail">Auto-checking results every 30 seconds...</p>
                        </div>
                        <!-- Current Status -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                           <p class="text-blue-800 font-medium" id="current-status">Starting loan automation workflows...</p>
                           <p class="text-blue-600 text-sm mt-1" id="status-detail">Please wait while we process your loans</p>
                        </div>
                     </div>
                  </div>
                  <!-- NEW: Pricing Review Section -->
                  <div id="pricing-review-section" class="hidden gradient-border rounded-xl shadow-lg p-8 mb-6 fade-in">
                     <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">💰 Pricing Results</h2>
                        <p class="text-gray-600">Review rates and select loans to lock</p>
                     </div>
                     <!-- Pricing Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                           <div class="text-2xl font-bold text-blue-800 mb-1" id="total-pricing-count">0</div>
                           <div class="text-blue-600 text-sm font-medium">Total Priced</div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                           <div class="text-2xl font-bold text-green-800 mb-1" id="selected-count">0</div>
                           <div class="text-green-600 text-sm font-medium">Selected to Lock</div>
                        </div>
                     </div>
                     <!-- Filter Controls -->
                     <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap items-center gap-4 justify-center">
                           <div class="flex items-center space-x-2">
                              <button id="select-all-btn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                              Select All
                              </button>
                              <button id="clear-all-btn" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                              Clear All
                              </button>
                           </div>
                        </div>
                     </div>
                     <!-- Pricing Table -->
                     <div class="pricing-table bg-white rounded-lg border overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b">
                           <h3 class="text-lg font-semibold text-gray-800">Loan Pricing Details</h3>
                        </div>
                        <div id="pricing-table-body" class="divide-y divide-gray-200">
                           <!-- Pricing rows will be inserted here dynamically -->
                        </div>
                     </div>
                     <!-- Lock Selected Button -->
                     <div class="text-center mt-8">
                        <button id="lock-selected-btn" class="bg-green-600 text-white px-12 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        🔒 Lock Selected Loans (<span id="lock-count">0</span>)
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Only selected loans will be locked</p>
                     </div>
                  </div>
                  <!-- Results Section -->
                  <div id="results-section" class="hidden gradient-border rounded-xl shadow-lg p-8 fade-in">
                     <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">✅ Processing Complete!</h2>
                        <p class="text-gray-600">Here are your loan processing results</p>
                     </div>
                     <!-- Summary Cards -->
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
                           <div class="text-4xl font-bold text-green-800 mb-2" id="locked-count">0</div>
                           <div class="text-green-600 font-medium">Successfully Locked</div>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-6 text-center">
                           <div class="text-4xl font-bold text-red-800 mb-2" id="failed-count">0</div>
                           <div class="text-red-600 font-medium">Failed to Lock</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                           <div class="text-4xl font-bold text-blue-800 mb-2" id="success-rate">0%</div>
                           <div class="text-blue-600 font-medium">Success Rate</div>
                        </div>
                     </div>
                     <!-- Processing Details -->
                     <div class="bg-gray-50 rounded-lg p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 Processing Summary</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                           <div>
                              <span class="font-medium text-gray-700">Total Processing Time:</span>
                              <span class="ml-2 text-gray-900" id="processing-time">0 minutes</span>
                           </div>
                           <div>
                              <span class="font-medium text-gray-700">Completed:</span>
                              <span class="ml-2 text-gray-900" id="completion-time">--</span>
                           </div>
                           <div>
                              <span class="font-medium text-gray-700">Username:</span>
                              <span class="ml-2 text-gray-900" id="processed-username">--</span>
                           </div>
                           <div>
                              <span class="font-medium text-gray-700">Status:</span>
                              <span class="ml-2 text-green-600 font-medium">Verified from automation logs</span>
                           </div>
                        </div>
                     </div>
                     <!-- Download & Reset -->
                     <div class="text-center space-y-4">
                        <button id="download-btn" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        📥 Download Detailed Results
                        </button>
                        <br>
                        <button id="reset-btn" class="bg-gray-600 text-white px-6 py-2 rounded-lg hover:bg-gray-700 transition-colors">
                        Process More Loans
                        </button>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <script>
         // Global variables
         let loans = [];
         let credentials = {};
         let batchStartTime = null;
         let processingStartTime = null;
         let checkInterval = null;
         let detailedResults = [];
         let pricingResults = [];
         let selectedLoans = [];
         let currentWorkflowType = 'auto-process'; // 'auto-process' or 'pricing-review'
         
         // Initialize validation system
         let loanValidator = null;
         let validationUI = null;
         
         // Initialize validation system when DOM is ready
         document.addEventListener('DOMContentLoaded', function() {
             console.log('🔍 Initializing LoanNex validation system...');
             loanValidator = new LoanValidator();
             validationUI = new ValidationUI(loanValidator);
             console.log('✅ Validation system ready');
         });
         
         // DOM elements
         const fileUpload = document.getElementById('file-upload');
         const fileName = document.getElementById('file-name');
         const loanCount = document.getElementById('loan-count');
         const processBtn = document.getElementById('process-btn');
         const priceReviewBtn = document.getElementById('price-review-btn');
         const downloadTemplate = document.getElementById('download-template');
         const uploadSection = document.getElementById('upload-section');
         const processingSection = document.getElementById('processing-section');
         const pricingReviewSection = document.getElementById('pricing-review-section');
         const resultsSection = document.getElementById('results-section');
         const workflowButtonsSection = document.getElementById('workflow-buttons-section');
         const validationSection = document.getElementById('validation-section');
         const totalLoans = document.getElementById('total-loans');
         const progressBar = document.getElementById('progress-bar');
         const currentStatus = document.getElementById('current-status');
         const statusDetail = document.getElementById('status-detail');
         const processingTitle = document.getElementById('processing-title');
         const lockedCount = document.getElementById('locked-count');
         const failedCount = document.getElementById('failed-count');
         const successRate = document.getElementById('success-rate');
         const processingTime = document.getElementById('processing-time');
         const completionTime = document.getElementById('completion-time');
         const processedUsername = document.getElementById('processed-username');
         const downloadBtn = document.getElementById('download-btn');
         const resetBtn = document.getElementById('reset-btn');
         
         // Pricing review elements
         const totalPricingCount = document.getElementById('total-pricing-count');
         const selectedCount = document.getElementById('selected-count');
         const pricingTableBody = document.getElementById('pricing-table-body');
         const lockSelectedBtn = document.getElementById('lock-selected-btn');
         const lockCount = document.getElementById('lock-count');
         const selectAllBtn = document.getElementById('select-all-btn');
         const clearAllBtn = document.getElementById('clear-all-btn');
         
         // Template download handler - Direct link to hosted template file
         downloadTemplate.addEventListener('click', function() {
             console.log('📥 Downloading LoanNex template Excel file...');
    
             // Create a temporary link element to trigger download
             const link = document.createElement('a');
    
             // Point to the Template Import.xlsx file in the same directory
             link.href = './Template Import.xlsx';
             link.download = 'LoanNex_Template_Import.xlsx';
             link.target = '_blank';
    
             // Trigger the download
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
    
             console.log('✅ Template Excel file download initiated');
        });
         
         // File upload handler - RESTORED with embedded validation
         fileUpload.addEventListener('change', function(event) {
             const file = event.target.files[0];
             if (!file) return;
             
             if (!validateCredentials()) {
                 event.target.value = '';
                 return;
             }
             
             console.log('📁 File selected:', file.name);
             
             const reader = new FileReader();
             reader.onload = function(e) {
                 try {
                     const data = new Uint8Array(e.target.result);
                     const workbook = XLSX.read(data, { type: 'array' });
                     const sheetName = workbook.SheetNames[0];
                     const worksheet = workbook.Sheets[sheetName];
                     const jsonData = XLSX.utils.sheet_to_json(worksheet);
                     
                     if (jsonData.length === 0) {
                         alert('The Excel file appears to be empty. Please check your file.');
                         return;
                     }
                     
                     loans = jsonData;
                     console.log('✅ Parsed loans:', loans.length);
                     
                     // Run REAL validation (embedded for now)
                     const validationResults = validateLoansBasic(loans);
                     
                     // Show validation section with REAL validation results
                     showValidationResults(validationResults);
                     
                     // Show workflow buttons only if validation passes
                     if (validationResults.canProceed) {
                         workflowButtonsSection.classList.remove('hidden');
                         console.log('✅ Validation passed - workflow buttons shown');
                     } else {
                         workflowButtonsSection.classList.add('hidden');
                         console.log('❌ Validation failed - workflow buttons hidden');
                     }
                     
                 } catch (error) {
                     console.error('Error parsing Excel file:', error);
                     alert('Error reading Excel file. Please ensure it\'s a valid .xlsx or .xls file.');
                 }
             };
             reader.readAsArrayBuffer(file);
         });
         
         // Basic validation function (embedded)
         function validateLoansBasic(loans) {
             const requiredFields = ['First Name', 'Last Name', 'Interest Rate', 'Investor', 'Credit Score', 'DTI', 'Loan Amount'];
             const validStates = ['AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA', 'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD', 'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ', 'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC', 'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY', 'DC'];
             
             let valid = 0, warnings = 0, errors = 0;
             const issues = [];
             
             loans.forEach((loan, index) => {
                 const loanIssues = [];
                 
                 // Check required fields
                 requiredFields.forEach(field => {
                     if (!loan[field] || loan[field].toString().trim() === '') {
                         loanIssues.push(`Missing ${field}`);
                         errors++;
                     }
                 });
                 
                 // Check state
                 if (loan['State'] && !validStates.includes(loan['State'].toString().trim().toUpperCase())) {
                     loanIssues.push(`Invalid state: ${loan['State']}`);
                     errors++;
                 }
                 
                 // Check credit score
                 const creditScore = parseFloat(loan['Credit Score']);
                 if (loan['Credit Score'] && (isNaN(creditScore) || creditScore < 300 || creditScore > 850)) {
                     loanIssues.push(`Invalid credit score: ${loan['Credit Score']}`);
                     errors++;
                 }
                 
                 // Check DTI
                 const dti = parseFloat(loan['DTI']);
                 if (loan['DTI'] && (isNaN(dti) || dti < 0 || dti > 100)) {
                     loanIssues.push(`Invalid DTI: ${loan['DTI']}`);
                     errors++;
                 }
                 
                 if (loanIssues.length === 0) {
                     valid++;
                 } else {
                     issues.push({
                         loanIndex: index,
                         borrower: `${loan['First Name'] || ''} ${loan['Last Name'] || ''}`.trim() || 'Unknown',
                         issues: loanIssues
                     });
                 }
             });
             
             return {
                 total: loans.length,
                 valid: valid,
                 warnings: warnings,
                 errors: errors,
                 canProceed: errors === 0,
                 issues: issues
             };
         }
         
         // Show validation results
         function showValidationResults(results) {
             validationSection.classList.remove('hidden');
             
             const statusColor = results.canProceed ? 'green' : 'red';
             const statusIcon = results.canProceed ? '✅' : '❌';
             const statusText = results.canProceed ? 'Ready to Process' : 'Errors Must Be Fixed';
             
             validationSection.innerHTML = `
                 <div class="text-center mb-6">
                     <h3 class="text-xl font-bold text-gray-900 mb-2">🔍 Validation Results</h3>
                     <p class="text-gray-600">Data validation complete</p>
                 </div>
                 
                 <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                     <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                         <div class="text-2xl font-bold text-blue-800 mb-1">${results.total}</div>
                         <div class="text-blue-600 text-sm font-medium">Total Loans</div>
                     </div>
                     <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                         <div class="text-2xl font-bold text-green-800 mb-1">${results.valid}</div>
                         <div class="text-green-600 text-sm font-medium">Valid</div>
                     </div>
                     <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                         <div class="text-2xl font-bold text-yellow-800 mb-1">${results.warnings}</div>
                         <div class="text-yellow-600 text-sm font-medium">Warnings</div>
                     </div>
                     <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                         <div class="text-2xl font-bold text-red-800 mb-1">${results.errors}</div>
                         <div class="text-red-600 text-sm font-medium">Errors</div>
                     </div>
                 </div>
                 
                 <div class="bg-${statusColor}-50 border border-${statusColor}-200 rounded-lg p-4 mb-4">
                     <div class="text-center text-${statusColor}-800 font-medium">
                         ${statusIcon} ${statusText}
                     </div>
                 </div>
                 
                 ${results.issues.length > 0 ? `
                     <div class="bg-white border rounded-lg overflow-hidden">
                         <div class="bg-red-50 px-4 py-3 border-b">
                             <h4 class="font-semibold text-red-800">Issues Found (${results.issues.length} loans)</h4>
                         </div>
                         <div class="max-h-64 overflow-y-auto">
                             ${results.issues.map(issue => `
                                 <div class="border-b p-4">
                                     <div class="font-medium text-gray-900">Loan #${issue.loanIndex + 1}: ${issue.borrower}</div>
                                     <ul class="text-sm text-red-600 mt-2 space-y-1">
                                         ${issue.issues.map(i => `<li>• ${i}</li>`).join('')}
                                     </ul>
                                 </div>
                             `).join('')}
                         </div>
                     </div>
                 ` : ''}
             `;
         }
         
         // Function to show/hide workflow buttons based on validation
         function updateWorkflowButtonsFromValidation(canProceed) {
             if (canProceed) {
                 workflowButtonsSection.classList.remove('hidden');
                 console.log('✅ Validation passed - workflow buttons shown');
             } else {
                 workflowButtonsSection.classList.add('hidden');
                 console.log('❌ Validation failed - workflow buttons hidden');
             }
         }
         
         // Validate credentials
         function validateCredentials() {
             const username = document.getElementById('username').value.trim();
             const password = document.getElementById('password').value.trim();
             
             if (!username || !password) {
                 alert('Please enter both LoanNex username and password.');
                 return false;
             }
             
             credentials = { username, password };
             return true;
         }
         
         
         
         // AUTO-PROCESS: Process & Lock All Loans (Original functionality)
         processBtn.addEventListener('click', async function() {
             if (!validateCredentials()) return;
             
             console.log('🔒 Starting AUTO-PROCESS workflow');
             currentWorkflowType = 'auto-process';
             
             processingStartTime = new Date();
             batchStartTime = new Date().toISOString();
             
             // Show processing UI
             uploadSection.classList.add('hidden');
             processingSection.classList.remove('hidden');
             
             // Update processing title
             processingTitle.textContent = `Auto-processing ${loans.length} loans...`;
             
             // Update initial status
             totalLoans.textContent = loans.length;
             currentStatus.textContent = `Triggering auto-process for ${loans.length} loans...`;
             statusDetail.textContent = 'Starting full automation workflows (login → price → lock)';
         
             try {
                 // Trigger all loans for auto-processing
                 for (let i = 0; i < loans.length; i++) {
                     updateStatus(`Triggering auto-process ${i + 1} of ${loans.length}...`, `Full automation workflow ${i + 1} starting`);
                     
                     await fetch('https://loannex-backend.vercel.app/api/trigger-loan-with-status', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             loanData: loans[i],
                             loanIndex: i,
                             credentials: credentials,
                             workflowType: 'process-loans' // Use auto-process workflow
                         })
                     });
                     
                     updateProgress((i + 1) / loans.length * 20);
                 }
         
                 updateStatus('All auto-process workflows started!', 'Now processing and locking loans in LoanNex - checking progress every 30 seconds');
                 
                 // Start auto-checking
                 startAutoChecking();
                 
             } catch (error) {
                 console.error('Error triggering auto-process:', error);
                 updateStatus('Error starting auto-process', 'Please try again or check your connection');
             }
         });
         
         // PRICING REVIEW: Get Pricing Only (New functionality)
         priceReviewBtn.addEventListener('click', async function() {
             if (!validateCredentials()) return;
             
             console.log('💰 Starting PRICING REVIEW workflow');
             currentWorkflowType = 'pricing-review';
             // Check if save option is enabled
             const saveCheckbox = document.getElementById('save-after-pricing');
             const shouldSave = saveCheckbox && saveCheckbox.checked;
             console.log(`💾 Save after pricing: ${shouldSave ? 'ENABLED' : 'DISABLED'}`);
             
             processingStartTime = new Date();
             batchStartTime = new Date().toISOString();
             
             // Show processing UI
             uploadSection.classList.add('hidden');
             processingSection.classList.remove('hidden');
             
             // Update processing title
             processingTitle.textContent = `Getting pricing for ${loans.length} loans...`;
             
             // Update initial status
             totalLoans.textContent = loans.length;
             currentStatus.textContent = `Getting pricing for ${loans.length} loans...`;
             statusDetail.textContent = 'Starting pricing workflows (login → price → stop before locking)';
         
             try {
                 // Trigger all loans for pricing only
                 for (let i = 0; i < loans.length; i++) {
                     updateStatus(`Getting pricing ${i + 1} of ${loans.length}...`, `Pricing workflow ${i + 1} starting`);
                     
                     await fetch('https://loannex-backend.vercel.app/api/trigger-pricing-only', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             loanData: loans[i],
                             loanIndex: i,
                             credentials: credentials,
                             shouldSave: shouldSave  // NEW: Add this line
                         })
                     });
                     
                     updateProgress((i + 1) / loans.length * 30);
                 }
         
                 updateStatus('All pricing workflows started!', 'Getting loan pricing data - checking progress every 30 seconds');
                 
                 // Start checking for pricing results
                 startPricingCheck();
                 
             } catch (error) {
                 console.error('Error triggering pricing:', error);
                 updateStatus('Error starting pricing', 'Please try again or check your connection');
             }
         });
         
         // Start checking for pricing results
         function startPricingCheck() {
             let checkCount = 0;
             const maxChecks = 20; // Shorter timeout for pricing
             
             checkInterval = setInterval(async () => {
                 checkCount++;
                 console.log(`💰 Pricing check ${checkCount}/${maxChecks}`);
                 
                 updateStatus('Checking pricing progress...', `Pricing check ${checkCount} - looking for completed pricing data`);
                 
                 try {
                     const response = await fetch('https://loannex-backend.vercel.app/api/get-pricing-results', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ batchStartTime: batchStartTime })
                     });
                     
                     const data = await response.json();
                     
                     if (data.success && data.pricingResults.length > 0) {
                         const totalPriced = data.pricingResults.length;
                         const expectedTotal = loans.length;
                         
                         // Update progress
                         const progressPercent = 30 + (totalPriced / expectedTotal) * 70;
                         updateProgress(progressPercent);
                         
                         updateStatus(
                             `${totalPriced} of ${expectedTotal} loans priced`,
                             `Pricing data retrieved successfully`
                         );
                         
                         // Check if all pricing done
                         if (totalPriced >= expectedTotal) {
                             console.log('💰 All pricing completed!');
                             clearInterval(checkInterval);
                             notifyPricingComplete();  // ADD THIS LINE
                             showPricingResults(data.pricingResults);
                         }
                     }
                     
                 } catch (error) {
                     console.error('Error checking pricing results:', error);
                     updateStatus('Continuing to get pricing...', 'Temporary check failed, will try again in 30 seconds');
                 }
                 
                 if (checkCount >= maxChecks) {
                     clearInterval(checkInterval);
                     updateStatus('Pricing timeout', 'Please check results manually or try again');
                 }
                 
             }, 30000);
         }
         
         // Show pricing results for review
         function showPricingResults(results) {
             pricingResults = results;
             selectedLoans = [];
             
             // Hide processing, show pricing review
             processingSection.classList.add('hidden');
             pricingReviewSection.classList.remove('hidden');
             
             // Update pricing summary
             totalPricingCount.textContent = results.length;
             selectedCount.textContent = '0';
             
             // Populate pricing table
             populatePricingTable(results);
             
             console.log('💰 Pricing results displayed:', results);
             console.log('💰 DEBUGGING: Full pricing data structure:', JSON.stringify(results, null, 2));
         }
         
         // Populate the pricing table
         function populatePricingTable(results) {
         pricingTableBody.innerHTML = '';
         
         results.forEach((result, index) => {
         const row = document.createElement('div');
         row.className = 'loan-row p-4 flex items-center justify-between hover:bg-gray-50 cursor-pointer';
         row.dataset.loanIndex = index;
         
         const borrowerName = result.borrowerName || 'Unknown Borrower';
         const interestRate = result.interestRate || 'N/A';
         const loanAmount = result.loanAmount ? `${parseInt(result.loanAmount).toLocaleString()}` : 'N/A';
         const investor = result.investor || 'N/A';
         const propertyType = result.propertyType || 'N/A';
         const amortizingType = result.amortizingType || 'N/A';
         
         // NEW FIELDS
         const pricePoints = result.pricePoints || 'N/A';
         const rateDescription = result.rateDescription || 'N/A';
         const productType = result.productType || 'N/A';
         
         // Rate highlighting
         let rateClass = '';
         const rate = parseFloat(interestRate);
         if (rate > 0) {
             if (rate < 7) rateClass = 'text-green-700 font-bold text-lg';
             else if (rate < 8) rateClass = 'text-blue-700 font-bold text-lg';
             else rateClass = 'text-red-700 font-bold text-lg';
         }
         
         // Price highlighting (green for negative points, red for positive points)
         let priceClass = '';
         const price = parseFloat(pricePoints);
         if (!isNaN(price)) {
             if (price < 0) priceClass = 'text-green-700 font-bold text-lg';  // Rebate (good)
             else if (price > 0) priceClass = 'text-red-700 font-bold text-lg';  // Cost (not ideal)
             else priceClass = 'text-blue-700 font-bold text-lg';  // Par pricing
         }
         
         row.innerHTML = `
             <div class="flex-1 min-w-0">
                 <div class="font-medium text-gray-900 truncate">${borrowerName}</div>
                 <div class="text-sm text-gray-500">${propertyType} • ${amortizingType}</div>
                 <div class="text-xs">
                     💾 
                     ${result.nex_id && result.nex_id !== 'Not Saved' && result.nex_id !== null ? 
                         `<a href="https://dev.loannex.com/iframe/loadiframe?page=loans&_id=${result.nex_id}" target="_blank" class="text-green-700 font-bold underline hover:text-blue-800">${result.nex_id}</a>` 
                         : '<span class="text-gray-600">Not Saved</span>'
                     }
                 </div>
             </div>
             <div class="flex items-center space-x-4 flex-wrap">
                 <div class="text-center min-w-0">
                     <div class="${rateClass}">${interestRate}${rate > 0 ? '%' : ''}</div>
                     <div class="text-xs text-gray-500">Rate</div>
                 </div>
                 <div class="text-center min-w-0">
                     <div class="${priceClass}">${pricePoints}</div>
                     <div class="text-xs text-gray-500">Price</div>
                 </div>
                 <div class="text-center min-w-0">
                     <div class="text-gray-900 text-sm">${rateDescription}</div>
                     <div class="text-xs text-gray-500">Lock Period</div>
                 </div>
                 <div class="text-center min-w-0">
                     <div class="text-gray-900 text-sm">${productType}</div>
                     <div class="text-xs text-gray-500">Product</div>
                 </div>
                 <div class="text-center min-w-0">
                     <div class="text-gray-900">${loanAmount}</div>
                     <div class="text-xs text-gray-500">Amount</div>
                 </div>
                 <div class="text-center min-w-0">
                     <div class="text-gray-700 text-sm">${investor}</div>
                     <div class="text-xs text-gray-500">Investor</div>
                 </div>
                 <div class="flex items-center">
                     <input type="checkbox" class="loan-checkbox" data-loan-index="${index}">
                 </div>
             </div>
         `;
         
         pricingTableBody.appendChild(row);
         });
         
         // Add checkbox event listeners
         document.querySelectorAll('.loan-checkbox').forEach(checkbox => {
         checkbox.addEventListener('change', updateSelectedCount);
         });
         }
         
         // Update selected loan count
         function updateSelectedCount() {
             const checkboxes = document.querySelectorAll('.loan-checkbox:checked');
             const count = checkboxes.length;
             
             selectedCount.textContent = count;
             lockCount.textContent = count;
             
             // Enable/disable lock button
             lockSelectedBtn.disabled = count === 0;
             
             // Update row styling
             document.querySelectorAll('.loan-row').forEach(row => {
                 const checkbox = row.querySelector('.loan-checkbox');
                 if (checkbox.checked) {
                     row.classList.add('selected');
                 } else {
                     row.classList.remove('selected');
                 }
             });
             
             selectedLoans = Array.from(checkboxes).map(cb => parseInt(cb.dataset.loanIndex));
         }
         
         // Select all loans
         selectAllBtn.addEventListener('click', function() {
             document.querySelectorAll('.loan-checkbox').forEach(checkbox => {
                 checkbox.checked = true;
             });
             updateSelectedCount();
         });
         
         // Clear all selections
         clearAllBtn.addEventListener('click', function() {
             document.querySelectorAll('.loan-checkbox').forEach(checkbox => {
                 checkbox.checked = false;
             });
             updateSelectedCount();
         });
         
         // Lock selected loans
         lockSelectedBtn.addEventListener('click', async function() {
             if (selectedLoans.length === 0) return;
             
             console.log(`🔒 Locking ${selectedLoans.length} selected loans`);
             
             // Hide pricing review, show processing
             pricingReviewSection.classList.add('hidden');
             processingSection.classList.remove('hidden');
             
             // Update processing for selective lock
             processingTitle.textContent = `Locking ${selectedLoans.length} selected loans...`;
             currentStatus.textContent = `Triggering selective locks for ${selectedLoans.length} loans...`;
             statusDetail.textContent = 'Starting optimized lock workflows for pre-approved loans';
             
             batchStartTime = new Date().toISOString(); // New batch time for locks
             
             try {
                 // Trigger selective locks for selected loans
                 for (let i = 0; i < selectedLoans.length; i++) {
                     const loanIndex = selectedLoans[i];
                     const loanData = loans[loanIndex];
                     
                     updateStatus(`Locking loan ${i + 1} of ${selectedLoans.length}...`, `Selective lock workflow ${i + 1} starting`);
                     
                     await fetch('https://loannex-backend.vercel.app/api/trigger-selective-locks', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({
                             loanData: loanData,
                             loanIndex: loanIndex,
                             credentials: credentials,
                             selectedLoans: selectedLoans
                         })
                     });
                     
                     updateProgress((i + 1) / selectedLoans.length * 20);
                 }
         
                 updateStatus('All selective locks started!', 'Now locking pre-approved loans - checking progress every 30 seconds');
                 
                 // Start auto-checking for lock results
                 startAutoChecking();
                 
             } catch (error) {
                 console.error('Error triggering selective locks:', error);
                 updateStatus('Error starting selective locks', 'Please try again or check your connection');
             }
         });
         
         // Auto-check results (works for both auto-process and selective lock)
         function startAutoChecking() {
             let checkCount = 0;
             const maxChecks = 30;
             
             checkInterval = setInterval(async () => {
                 checkCount++;
                 console.log(`🔍 Auto-check ${checkCount}/${maxChecks} for ${currentWorkflowType}`);
                 
                 updateStatus('Checking automation progress...', `Auto-check ${checkCount} - looking for completed loans`);
                 
                 try {
                     const response = await fetch('https://loannex-backend.vercel.app/api/check-batch-results', {
                         method: 'POST',
                         headers: { 'Content-Type': 'application/json' },
                         body: JSON.stringify({ batchStartTime: batchStartTime })
                     });
                     
                     const data = await response.json();
                     
                     if (data.success) {
                         const { summary } = data;
                         const totalProcessed = summary.totalProcessed;
                         const expectedTotal = currentWorkflowType === 'auto-process' ? loans.length : selectedLoans.length;
                         
                         // Update progress
                         const progressPercent = 20 + (totalProcessed / expectedTotal) * 80;
                         updateProgress(progressPercent);
                         
                         updateStatus(
                             `${totalProcessed} of ${expectedTotal} loans completed`,
                             `${summary.successfulLocks} locked, ${summary.failedLocks} failed`
                         );
                         
                         // Check if all done
                         if (summary.isComplete && totalProcessed >= expectedTotal) {
                             console.log('🎉 All loans completed!');
                             clearInterval(checkInterval);
                             showResults(data);
                         }
                     }
                     
                 } catch (error) {
                     console.error('Error checking results:', error);
                     updateStatus('Continuing to process...', 'Temporary check failed, will try again in 30 seconds');
                 }
                 
                 if (checkCount >= maxChecks) {
                     clearInterval(checkInterval);
                     updateStatus('Processing timeout', 'Please check results manually or try again');
                 }
                 
             }, 30000);
         }
         
         // Update processing status
         function updateStatus(status, detail) {
             currentStatus.textContent = status;
             statusDetail.textContent = detail;
         }
         
         // Update progress bar
         function updateProgress(percent) {
             progressBar.style.width = `${Math.min(percent, 100)}%`;
         }
         
         // Show final results
         function showResults(data) {
             const { summary, results } = data;
             
             // Store detailed results for download
             detailedResults = results || [];
             
             // Hide processing, show results
             processingSection.classList.add('hidden');
             resultsSection.classList.remove('hidden');
             
             // Update result counts
             lockedCount.textContent = summary.successfulLocks;
             failedCount.textContent = summary.failedLocks;
             successRate.textContent = `${summary.successRate}%`;
             
             // Update processing details
             const endTime = new Date();
             const totalMinutes = Math.round((endTime - processingStartTime) / 60000);
             processingTime.textContent = `${totalMinutes} minutes`;
             completionTime.textContent = endTime.toLocaleString();
             processedUsername.textContent = credentials.username;
             
             console.log('✅ Results displayed with detailed data:', detailedResults);
         }
         
         // Download results
         downloadBtn.addEventListener('click', function() {
             console.log('📥 Generating enhanced Excel download with failure reasons...');
             
             // Create enhanced results data by matching loans with API results
             const enhancedResultsData = loans.map((loan, index) => {
                 // Try multiple strategies to find matching result
                 let apiResult = null;
                 
                 apiResult = detailedResults.find(r => r.loanIndex === (index + 1));
                 
                 if (!apiResult) {
                     apiResult = detailedResults.find(r => r.loanIndex === index);
                 }
                 
                 if (!apiResult && detailedResults.length === loans.length) {
                     apiResult = detailedResults[index];
                 }
                 
                 if (!apiResult && index < detailedResults.length) {
                     apiResult = detailedResults[index];
                 }
                 
                 // Determine status and failure reason
                 let status, failureReason, lockStatus;
                 
                 if (apiResult && apiResult.locked === true) {
                     status = 'SUCCESS - LOAN LOCKED';
                     lockStatus = '🔒 LOCKED';
                     failureReason = '';
                 } else if (apiResult && apiResult.locked === false) {
                     status = 'FAILED - NOT LOCKED';
                     lockStatus = '🔓 NOT LOCKED';
                     failureReason = apiResult.errorMessage || 'Unknown error occurred';
                 } else {
                     status = 'PROCESSING ERROR';
                     lockStatus = '❓ UNKNOWN';
                     failureReason = apiResult ? 'Could not determine final status' : 'No matching API result found';
                 }
                 
                 return {
                     // Key results first
                     'Loan #': index + 1,
                     'Borrower Name': `${loan['First Name'] || ''} ${loan['Last Name'] || ''}`.trim() || 'Unknown',
                     'FINAL STATUS': status,
                     'Lock Status': lockStatus,
                     'Failure Reason': failureReason,
                     'GitHub Actions URL': apiResult ? apiResult.githubUrl || '' : '',
                     
                     // Loan details
                     'Interest Rate': loan['Interest Rate'] || '',
                     'Investor': loan['Investor'] || '',
                     'Amortizing Type': loan['Amortizing Type'] || '',
                     'Prepay Penalty': loan['Prepay Penalty'] || '',
                     'Property Type': loan['Property Type'] || '',
                     'Loan Amount': loan['Loan Amount'] || '',
                     'Occupancy': loan['Occupancy'] || '',
                     'LTV': loan['LTV'] || '',
                     'Credit Score': loan['Credit Score'] || '',
                     'DTI': loan['DTI'] || '',
                     'State': loan['State'] || '',
                     'County': loan['County'] || '',
                     
                     // Processing metadata
                     'Processing Date': new Date().toLocaleString(),
                     'Username': credentials.username,
                     'Workflow Type': currentWorkflowType,
                     'Workflow ID': apiResult ? apiResult.workflowId || '' : '',
                     'Completed At': apiResult ? apiResult.completedAt || '' : '',
                     'Analysis Method': apiResult ? apiResult.status || 'unknown' : 'no_match',
                     
                     // All original loan data
                     ...loan
                 };
             });
         
             // Enhanced summary with failure analysis
             const failureReasons = detailedResults
                 .filter(r => r.locked === false && r.errorMessage)
                 .map(r => r.errorMessage);
             
             const failureCounts = {};
             failureReasons.forEach(reason => {
                 let category = 'Other';
                 if (reason.includes('Investor') && reason.includes('not found')) {
                     category = 'Investor Not Found';
                 } else if (reason.includes('Prepay Penalty')) {
                     category = 'Prepay Penalty Issue';
                 } else if (reason.includes('Interest rate') || reason.includes('filtered out')) {
                     category = 'Interest Rate Mismatch';
                 } else if (reason.includes('Login failed')) {
                     category = 'Login/Authentication Error';
                 } else if (reason.includes('No loans available')) {
                     category = 'No Loans Available After Filtering';
                 }
                 
                 failureCounts[category] = (failureCounts[category] || 0) + 1;
             });
             
             const mostCommonFailure = Object.keys(failureCounts).length > 0 
                 ? Object.keys(failureCounts).reduce((a, b) => failureCounts[a] > failureCounts[b] ? a : b)
                 : 'None';
         
             const summaryData = [{
                 'Total Loans Processed': loans.length,
                 'Successfully Locked': lockedCount.textContent,
                 'Failed to Lock': failedCount.textContent,
                 'Success Rate': successRate.textContent,
                 'Workflow Type': currentWorkflowType === 'auto-process' ? 'Auto-Process & Lock' : 'Price Review & Selective Lock',
                 'Most Common Failure Reason': mostCommonFailure,
                 'Processing Completed': completionTime.textContent,
                 'Username': credentials.username,
                 'Total Processing Time': processingTime.textContent,
                 'Verification Method': 'Real-time GitHub Actions workflow analysis',
                 'Report Generated': new Date().toLocaleString()
             }];
         
             // Failure breakdown sheet
             const failureBreakdownData = Object.keys(failureCounts).map(category => ({
                 'Failure Category': category,
                 'Number of Loans': failureCounts[category],
                 'Percentage': Math.round((failureCounts[category] / failureReasons.length) * 100) + '%'
             }));
         
             // Create Excel workbook
             const wb = XLSX.utils.book_new();
             
             const summaryWs = XLSX.utils.json_to_sheet(summaryData);
             XLSX.utils.book_append_sheet(wb, summaryWs, 'Executive Summary');
             
             const resultsWs = XLSX.utils.json_to_sheet(enhancedResultsData);
             XLSX.utils.book_append_sheet(wb, resultsWs, 'Detailed Results');
             
             if (failureBreakdownData.length > 0) {
                 const failureWs = XLSX.utils.json_to_sheet(failureBreakdownData);
                 XLSX.utils.book_append_sheet(wb, failureWs, 'Failure Analysis');
             }
             
             const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
             const successCount = lockedCount.textContent;
             const workflowType = currentWorkflowType === 'auto-process' ? 'autoprocess' : 'selective';
             const filename = `loannex_${workflowType}_${successCount}locked_${timestamp}.xlsx`;
             
             XLSX.writeFile(wb, filename);
             
             console.log('✅ Enhanced Excel file downloaded:', filename);
         });
         
         // Reset for new batch
         resetBtn.addEventListener('click', function() {
             loans = [];
             credentials = {};
             batchStartTime = null;
             processingStartTime = null;
             detailedResults = [];
             pricingResults = [];
             selectedLoans = [];
             currentWorkflowType = 'auto-process';
             
             if (checkInterval) {
                 clearInterval(checkInterval);
                 checkInterval = null;
             }
             
             resultsSection.classList.add('hidden');
             pricingReviewSection.classList.add('hidden');
             processingSection.classList.add('hidden');
             validationSection.classList.add('hidden');
             workflowButtonsSection.classList.add('hidden');
             uploadSection.classList.remove('hidden');
             
             document.getElementById('username').value = '';
             document.getElementById('password').value = '';
             document.getElementById('file-upload').value = '';
             
             console.log('🔄 Reset for new batch');
         });
         
         console.log('✨ LoanNex Automation Portal with DUAL WORKFLOW SYSTEM loaded!');
         console.log('🔒 Auto-Process: Process & Lock All Loans');
         console.log('💰 Pricing Review: Price → Review → Select → Lock');
         
         // Initialize floating particles
         function createParticles() {
             const container = document.getElementById('particles-container');
             const particleCount = 50;
         
             for (let i = 0; i < particleCount; i++) {
                 const particle = document.createElement('div');
                 particle.className = 'particle';
                 
                 // Random starting position
                 particle.style.left = Math.random() * 100 + '%';
                 particle.style.animationDelay = Math.random() * 20 + 's';
                 particle.style.animationDuration = (20 + Math.random() * 10) + 's';
                 
                 // Random horizontal drift
                 particle.style.setProperty('--drift', (Math.random() - 0.5) * 200 + 'px');
                 
                 container.appendChild(particle);
             }
         }
         
         // Initialize particles when page loads
         createParticles();
         
         // Architecture collapse/expand functionality
         const architectureToggle = document.getElementById('architecture-toggle');
         const architectureContent = document.getElementById('architecture-content');
         const expandIcon = document.getElementById('expand-icon');
         
         architectureToggle.addEventListener('click', function() {
             const isHidden = architectureContent.classList.contains('hidden');
             
             if (isHidden) {
                 // Expand
                 architectureContent.classList.remove('hidden');
                 expandIcon.style.transform = 'rotate(180deg)';
                 architectureToggle.querySelector('span').textContent = 'Click to collapse';
             } else {
                 // Collapse
                 architectureContent.classList.add('hidden');
                 expandIcon.style.transform = 'rotate(0deg)';
                 architectureToggle.querySelector('span').textContent = 'Click to expand';
             }
         });
         
         // Add this new function to handle notifications
         function notifyPricingComplete() {
             // 1. Change tab title with blinking effect
             const originalTitle = document.title;
             let isBlinking = true;
             let blinkCount = 0;
             const maxBlinks = 6; // Blink 3 times (on/off = 2 blinks per cycle)
             
             const blinkInterval = setInterval(() => {
                 document.title = isBlinking ? '✅ PRICING COMPLETE! - LoanNex' : '⭐ REVIEW FOR LOCK - LoanNex';
                 isBlinking = !isBlinking;
                 blinkCount++;
                 
                 if (blinkCount >= maxBlinks) {
                     clearInterval(blinkInterval);
                     document.title = '✅ PRICING COMPLETE! - LoanNex';
                 }
             }, 800); // Blink every 800ms
             
             // 2. Play notification sound with text-to-speech
             try {
                 const audio = document.getElementById('pricing-complete-audio');
                 if (audio) {
                     audio.play().catch(e => console.log('Audio play failed:', e));
                 }
                 
                 // Use browser's speech synthesis for the message
                 if ('speechSynthesis' in window) {
                     const utterance = new SpeechSynthesisUtterance('Pricing is complete, review for lock');
                     utterance.rate = 0.9;
                     utterance.pitch = 1.1;
                     utterance.volume = 0.8;
                     speechSynthesis.speak(utterance);
                 }
             } catch (error) {
                 console.log('Notification audio failed:', error);
             }
             
             console.log('🔔 Pricing completion notifications triggered');
         }
      </script>
      
      <!-- Load validation integration script last to ensure all classes are available -->
      <script src="validation-integration.js"></script>
   </body>
</html>
