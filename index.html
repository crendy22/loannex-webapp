<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanNex Automation Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .progress-bar { transition: width 0.3s ease; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* News ticker animation */
        .animate-scroll {
            animation: scroll 60s linear infinite;
        }
        @keyframes scroll {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Floating particles background */
        .particles-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: rgba(59, 130, 246, 0.4);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        .particle:nth-child(odd) {
            background: rgba(139, 92, 246, 0.3);
            animation-duration: 25s;
        }

        .particle:nth-child(3n) {
            background: rgba(16, 185, 129, 0.3);
            animation-duration: 30s;
            width: 2px;
            height: 2px;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0px) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-10vh) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Gradient border animations */
        .gradient-border {
            position: relative;
            background: white;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #10b981, #f59e0b, #ef4444, #3b82f6);
            background-size: 300% 300%;
            border-radius: inherit;
            animation: gradientShift 3s ease infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
        }

        .gradient-border-subtle {
            position: relative;
            background: white;
        }

        .gradient-border-subtle::before {
            content: '';
            position: absolute;
            inset: 0;
            padding: 1px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #3b82f6);
            background-size: 200% 200%;
            border-radius: inherit;
            animation: gradientShift 4s ease-in-out infinite;
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask-composite: xor;
            -webkit-mask-composite: xor;
        }

        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Enhanced content positioning */
        .content-layer {
            position: relative;
            z-index: 10;
        }

        /* Fix for form inputs inside gradient borders */
        .gradient-border input,
        .gradient-border button,
        .gradient-border select,
        .gradient-border textarea,
        .gradient-border label,
        .gradient-border .cursor-pointer {
            position: relative;
            z-index: 20;
        }

        .gradient-border-subtle input,
        .gradient-border-subtle button,
        .gradient-border-subtle select,
        .gradient-border-subtle textarea,
        .gradient-border-subtle label,
        .gradient-border-subtle .cursor-pointer {
            position: relative;
            z-index: 20;
        }

        /* Ensure all content inside gradient borders is clickable */
        .gradient-border > *,
        .gradient-border-subtle > * {
            position: relative;
            z-index: 15;
        }

        /* Custom styles for pricing table */
        .pricing-table {
            max-height: 60vh;
            overflow-y: auto;
        }

        .rate-highlight {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .loan-row:hover {
            background-color: #f3f4f6;
        }

        .loan-row.selected {
            background-color: #dbeafe;
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    
    <!-- Floating Particles Background -->
    <div class="particles-container" id="particles-container"></div>

    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 content-layer">
        <!-- Non-QM News Ticker -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-3 overflow-hidden">
            <div class="max-w-7xl mx-auto flex items-center">
                <div class="bg-white text-blue-700 px-3 py-1 rounded-full text-sm font-bold mr-4 flex-shrink-0">
                    üìà NON-QM NEWS
                </div>
                <div class="overflow-hidden flex-1">
                    <div id="news-ticker" class="whitespace-nowrap animate-scroll text-sm">
                        <span class="inline-block mr-12">üöÄ 2025 predicted to be strongest year for Non-QM market</span>
                        <span class="inline-block mr-12">üí∞ A&D Mortgage closes $427M securitization</span>
                        <span class="inline-block mr-12">üìä Non-QM market now 5% of total mortgage market</span>
                        <span class="inline-block mr-12">‚≠ê Average Non-QM credit score: 776</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto p-6">
            <!-- Collapsible Data Flow Architecture -->
            <div class="mb-6">
                <div class="gradient-border-subtle rounded-xl shadow-lg overflow-hidden">
                    <button 
                        id="architecture-toggle" 
                        class="w-full p-4 bg-gradient-to-r from-blue-50 to-indigo-50 hover:from-blue-100 hover:to-indigo-100 transition-all duration-300 flex items-center justify-between group"
                    >
                        <div class="flex items-center space-x-3">
                            <div class="bg-blue-600 text-white p-2 rounded-lg">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="text-left">
                                <h3 class="font-bold text-gray-900 text-lg">LoanNex Data Processing Pipeline</h3>
                                <p class="text-sm text-gray-600">View the complete automation workflow architecture</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-blue-600 font-medium group-hover:text-blue-700">Click to expand</span>
                            <svg id="expand-icon" class="w-6 h-6 text-blue-600 transition-transform duration-300 group-hover:text-blue-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </button>
                    
                    <div id="architecture-content" class="hidden border-t border-gray-200">
                        <div class="p-6 bg-white">
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
                                <!-- INPUT PHASE -->
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-blue-100 to-blue-200 p-3 rounded-lg">
                                        <h4 class="font-bold text-blue-900 text-sm mb-2">INPUT PHASE</h4>
                                        <div class="text-xs text-blue-800 leading-relaxed">
                                            üìä EXCEL UPLOAD<br>
                                            ‚Üì<br>
                                            üîç VALIDATION<br>
                                            ‚Üì<br>
                                            ‚úÖ AUTHENTICATION<br>
                                            ‚Üì<br>
                                            üìã PREVIEW
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        <div>‚Ä¢ Upload loan spreadsheet</div>
                                        <div>‚Ä¢ Validate file format</div>
                                        <div>‚Ä¢ Verify LoanNex credentials</div>
                                        <div>‚Ä¢ Display data preview</div>
                                    </div>
                                </div>

                                <!-- PROCESSING PHASE -->
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-green-100 to-green-200 p-3 rounded-lg">
                                        <h4 class="font-bold text-green-900 text-sm mb-2">PROCESSING PHASE</h4>
                                        <div class="text-xs text-green-800 leading-relaxed">
                                            ‚ö° API ORCHESTRATION<br>
                                            ‚Üì<br>
                                            üöÄ WORKFLOW LAUNCH<br>
                                            ‚Üì<br>
                                            üñ•Ô∏è BROWSER AUTOMATION
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        <div>‚Ä¢ Trigger GitHub workflows</div>
                                        <div>‚Ä¢ Provision Ubuntu VMs</div>
                                        <div>‚Ä¢ Navigate with Selenium</div>
                                        <div>‚Ä¢ Chrome browser setup</div>
                                    </div>
                                </div>

                                <!-- AUTOMATION PHASE -->
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-purple-100 to-purple-200 p-3 rounded-lg">
                                        <h4 class="font-bold text-purple-900 text-sm mb-2">AUTOMATION PHASE</h4>
                                        <div class="text-xs text-purple-800 leading-relaxed">
                                            üè¶ LOANNEX LOGIN<br>
                                            ‚Üì<br>
                                            üìù FIELD POPULATION<br>
                                            ‚Üì<br>
                                            üí∞ PRICE GENERATION<br>
                                            ‚Üì<br>
                                            üéØ SMART FILTERING
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        <div>‚Ä¢ Secure authentication</div>
                                        <div>‚Ä¢ Populate 23+ fields</div>
                                        <div>‚Ä¢ Generate pricing data</div>
                                        <div>‚Ä¢ Apply loan filters</div>
                                    </div>
                                </div>

                                <!-- EXECUTION PHASE -->
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-orange-100 to-orange-200 p-3 rounded-lg">
                                        <h4 class="font-bold text-orange-900 text-sm mb-2">EXECUTION PHASE</h4>
                                        <div class="text-xs text-orange-800 leading-relaxed">
                                            üîí LOCK ATTEMPT<br>
                                            ‚Üì<br>
                                            üìä LOG ANALYSIS<br>
                                            ‚Üì<br>
                                            üìà REAL-TIME MONITORING<br>
                                            ‚Üì<br>
                                            ‚úÖ RESULT CAPTURE
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        <div>‚Ä¢ Execute loan lock</div>
                                        <div>‚Ä¢ Parse automation logs</div>
                                        <div>‚Ä¢ Auto-poll every 30s</div>
                                        <div>‚Ä¢ Correlate results</div>
                                    </div>
                                </div>

                                <!-- OUTPUT PHASE -->
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-red-100 to-red-200 p-3 rounded-lg">
                                        <h4 class="font-bold text-red-900 text-sm mb-2">OUTPUT PHASE</h4>
                                        <div class="text-xs text-red-800 leading-relaxed">
                                            üìã DATA COMPILATION<br>
                                            ‚Üì<br>
                                            üìä EXCEL GENERATION<br>
                                            ‚Üì<br>
                                            üì• PROFESSIONAL DOWNLOAD
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-700 space-y-1">
                                        <div>‚Ä¢ Match loan data</div>
                                        <div>‚Ä¢ Generate Excel report</div>
                                        <div>‚Ä¢ Timestamped results</div>
                                        <div>‚Ä¢ Actionable insights</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-6">
                <!-- Main Content Area (Full Width) -->
                <div>
                    <div id="app">
                
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-gray-900 mb-2">üè¶ LoanNex Automation Portal</h1>
                    <p class="text-lg text-gray-600">Simple, reliable loan processing and lock automation</p>
                </div>

                <!-- Upload Section -->
                <div id="upload-section" class="gradient-border rounded-xl shadow-lg p-8 mb-6">
                    <h2 class="text-2xl font-semibold mb-6 text-center">Process Your Loans</h2>
                    
                    <!-- Credentials -->
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">LoanNex Username</label>
                            <input 
                                type="text" 
                                id="username" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="Enter username"
                                required
                            >
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">LoanNex Password</label>
                            <input 
                                type="password" 
                                id="password" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                placeholder="Enter password"
                                required
                            >
                        </div>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div class="mb-4">
                            <label for="file-upload" class="cursor-pointer">
                                <span class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors inline-block font-medium">
                                    Choose Excel File
                                </span>
                                <input id="file-upload" type="file" class="hidden" accept=".xlsx,.xls">
                            </label>
                        </div>
                        <p class="text-sm text-gray-500 mb-3">Upload your loan data in Excel format</p>
                        
                        <!-- Template Download Button -->
                        <div class="pt-3 border-t border-gray-200">
                            <button id="download-template" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                                üì• Download Excel Template
                            </button>
                            <p class="text-xs text-gray-500 mt-2">Get the required format with allowable values</p>
                        </div>
                    </div>

                    <!-- File Status -->
                    <div id="file-status" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg mb-6">
                        <p class="text-green-800 font-medium" id="file-name"></p>
                        <p class="text-green-600 text-sm" id="loan-count"></p>
                    </div>

                    <!-- Process Buttons - NOW TWO OPTIONS -->
                    <div class="text-center space-y-4">
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                            <!-- Original Process Button -->
                            <button id="process-btn" class="hidden bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg">
                                üîí Process & Lock Loans
                            </button>
                            
                            <!-- NEW: Price Review Button -->
                            <button id="price-review-btn" class="hidden bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-medium text-lg">
                                üí∞ Price & Review Loans
                            </button>
                        </div>
                        
                        <div class="text-xs text-gray-500 max-w-2xl mx-auto">
                            <p><strong>Process & Lock:</strong> Automatically process and lock all loans (original functionality)</p>
                            <p><strong>Price & Review:</strong> Get pricing first, then review and select which loans to lock</p>
                        </div>
                    </div>
                </div>

                <!-- Processing Section -->
                <div id="processing-section" class="hidden gradient-border-subtle rounded-xl shadow-lg p-8 mb-6">
                    <div class="text-center">
                        <div class="mb-6">
                            <div class="inline-flex items-center text-blue-600 text-xl font-medium mb-4">
                                <div class="pulse mr-3">‚ö°</div>
                                <span id="processing-title">Processing <span id="total-loans">0</span> loans...</span>
                            </div>
                        </div>
                        
                        <!-- Progress Bar -->
                        <div class="mb-6">
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div id="progress-bar" class="bg-blue-600 h-4 rounded-full progress-bar" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2" id="progress-detail">Auto-checking results every 30 seconds...</p>
                        </div>

                        <!-- Current Status -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-blue-800 font-medium" id="current-status">Starting loan automation workflows...</p>
                            <p class="text-blue-600 text-sm mt-1" id="status-detail">Please wait while we process your loans</p>
                        </div>
                    </div>
                </div>

                <!-- NEW: Pricing Review Section -->
                <div id="pricing-review-section" class="hidden gradient-border rounded-xl shadow-lg p-8 mb-6 fade-in">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">üí∞ Pricing Results</h2>
                        <p class="text-gray-600">Review rates and select loans to lock</p>
                    </div>

                    <!-- Pricing Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-800 mb-1" id="total-pricing-count">0</div>
                            <div class="text-blue-600 text-sm font-medium">Total Priced</div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-800 mb-1" id="selected-count">0</div>
                            <div class="text-green-600 text-sm font-medium">Selected to Lock</div>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-purple-800 mb-1" id="avg-rate">0.00%</div>
                            <div class="text-purple-600 text-sm font-medium">Average Rate</div>
                        </div>

                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-orange-800 mb-1" id="best-rate">0.00%</div>
                            <div class="text-orange-600 text-sm font-medium">Best Rate Available</div>
                        </div>
                    </div>

                    <!-- Filter Controls -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="flex flex-wrap items-center gap-4">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">Filter by Rate:</label>
                                <select id="rate-filter" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="">All Rates</option>
                                    <option value="low">Under 7%</option>
                                    <option value="mid">7% - 8%</option>
                                    <option value="high">Above 8%</option>
                                </select>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <label class="text-sm font-medium text-gray-700">Sort by:</label>
                                <select id="sort-filter" class="px-3 py-1 border border-gray-300 rounded text-sm">
                                    <option value="rate">Interest Rate</option>
                                    <option value="borrower">Borrower Name</option>
                                    <option value="amount">Loan Amount</option>
                                </select>
                            </div>

                            <div class="flex items-center space-x-2">
                                <button id="select-all-btn" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Select All
                                </button>
                                <button id="clear-all-btn" class="bg-gray-600 text-white px-3 py-1 rounded text-sm hover:bg-gray-700">
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Table -->
                    <div class="pricing-table bg-white rounded-lg border overflow-hidden">
                        <div class="bg-gray-50 px-6 py-3 border-b">
                            <h3 class="text-lg font-semibold text-gray-800">Loan Pricing Details</h3>
                        </div>
                        
                        <div id="pricing-table-body" class="divide-y divide-gray-200">
                            <!-- Pricing rows will be inserted here dynamically -->
                        </div>
                    </div>

                    <!-- Lock Selected Button -->
                    <div class="text-center mt-8">
                        <button id="lock-selected-btn" class="bg-green-600 text-white px-12 py-4 rounded-lg hover:bg-green-700 transition-colors font-medium text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            üîí Lock Selected Loans (<span id="lock-count">0</span>)
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Only selected loans will be locked</p>
                    </div>
                </div>

                <!-- Results Section (same as before) -->
                <div id="results-section" class="hidden gradient-border rounded-xl shadow-lg p-8 fade-in">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">‚úÖ Processing Complete!</h2>
                        <p class="text-gray-600">Here are your loan processing results</p>
                    </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-green-50
